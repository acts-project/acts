# This file is part of the ACTS project.
#
# Copyright (C) 2016 CERN for the benefit of the ACTS project
#
# This Source Code Form is subject to the terms of the Mozilla Public
# License, v. 2.0. If a copy of the MPL was not distributed with this
# file, You can obtain one at https://mozilla.org/MPL/2.0/.

# This script sets up the ACTS environment with dependencies in a somewhat robust way.

IS_INSTALLED_VERSION="@IS_INSTALLED_VERSION@"
ROOT_DIR="@ROOT_DIR@"
ROOT_BINDIR="@ROOT_BINDIR@"
GEANT4_DIR="@GEANT4_DIR@"
GEANT4_INCLUDE_DIR="@GEANT4_INCLUDE_DIR@"
DD4hep_DIR="@DD4hep_DIR@"
DD4hep_INCLUDE_DIRS="@DD4hep_INCLUDE_DIRS@"
podio_DIR="@podio_DIR@"
podio_LIBRARY_DIR="@podio_LIBRARY_DIR@"
podio_INCLUDE_DIR="@podio_INCLUDE_DIR@"
podio_PYTHON_DIR="@podio_PYTHON_DIR@"
EDM4HEP_DIR="@EDM4HEP_DIR@"
EDM4HEP_LIBRARY_DIR="@EDM4HEP_LIBRARY_DIR@"
EDM4HEP_INCLUDE_DIR="@EDM4HEP_INCLUDE_DIR@"

if [ -n "${ZSH_VERSION:-}" ]; then
    script_dir=${0:a:h}
elif [ -n "${BASH_VERSION:-}" ]; then
    script_dir=$( cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )
else
    # If the current shell is not ZSH or Bash, we can't guarantee that the
    # script will work, so we throw an error.
    echo "ERROR:   neither ZSH nor Bash was detected, other shells are not supported. The environment has not been modified."
    exit 1
fi

# detect if we are installed as there is no lib subdirectory
if [[ -n "${IS_INSTALLED_VERSION}" && ! "${IS_INSTALLED_VERSION,,}" == "off" ]]; then
    script_dir=$( cd -- "${script_dir}" &> /dev/null && cd .. &> /dev/null && pwd )
fi

# remember which path we used for python
python_path=$(which python3)
python_path=$(dirname "${python_path}")

# source the basic ACTS environment
source "${script_dir}/this_acts.sh"

# activate dependencies if present
if [[ -n "${ROOT_SETUP_SCRIPT:-}" ]]; then
  # Dependency setup script has already given us this location!
  source "$ROOT_SETUP_SCRIPT"
else
  # Try to recover the build-time configuration
  if [[ -d "${ROOT_DIR}" ]]; then
    source "${ROOT_BINDIR}/thisroot.sh"
  fi
fi
if [[ -d "${GEANT4_DIR}" ]]; then
  source "${GEANT4_INCLUDE_DIR}/../../bin/geant4.sh"
fi
if [[ -d "${DD4hep_DIR}" ]]; then
  prevstate=$-

  set +e
  source "${DD4hep_INCLUDE_DIRS}/../bin/thisdd4hep.sh"
  # Without this, DD4hep's Xerces-C XML parsing fails with:
  # > Could not load a transcoding service
  export LC_ALL=C

  if [[ "$prevstate" == *e* ]]; then
    # -e was set before, re-enabling
    set -e
  fi
fi
if [[ -d "${podio_DIR}" ]]; then
  export LD_LIBRARY_PATH="${podio_LIBRARY_DIR}:${LD_LIBRARY_PATH}"
  export DYLD_LIBRARY_PATH="${podio_LIBRARY_DIR}:${DYLD_LIBRARY_PATH}"
  export ROOT_INCLUDE_PATH="${podio_INCLUDE_DIR}:${ROOT_INCLUDE_PATH}"
  export PYTHONPATH="${podio_PYTHON_DIR}:${PYTHONPATH}"
fi
if [[ -d "${EDM4HEP_DIR}" ]]; then
  export LD_LIBRARY_PATH="${EDM4HEP_LIBRARY_DIR}/lib:${LD_LIBRARY_PATH}"
  export DYLD_LIBRARY_PATH="${EDM4HEP_LIBRARY_DIR}/lib:${DYLD_LIBRARY_PATH}"
  export ROOT_INCLUDE_PATH="${EDM4HEP_INCLUDE_DIR}:${ROOT_INCLUDE_PATH}"
fi

# ensure that we end up with the same python as before sourcing this script
# this was observed to be a problem as other activation scripts like ROOT modify PATH
export PATH="${python_path}:${PATH}"
